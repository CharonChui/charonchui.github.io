播放器性能优化
===

播放器相关问题:   
- 业务耦合
- 成功率低
- 不支持边下边播，缓冲时间长
- 成本优化
- 问题定位难




### 成本优化

#### 预下载控制
- 不限速
- 非高峰时段，预下载N秒
- 高峰时段，预下载M秒
- 高峰期动态码率

#### H265

- 压缩率提升 30%
- 相比H264,编码复杂度提升4倍，更消耗系统资源
- 编码时间更长

通过软解可以支持，但是CPU会占用较高，而且发热和好点。
对解码能力进行评估，来通过机型打分控制是否使用H265以及是用360p还是480p。   
但是H265全部切换成本较高，牵扯到转码成本以及存储成本，所以可以只对热点的视频去进行编码，这样少量的视频就可以带来可观的效果。

### 秒开

能立即起播，不会产生缓冲
播放器初始化->业务逻辑->DNS解析->CDN下载数据->解码->渲染播放

#### MOOV后置

很多手机为了偷懒，录制完视频后才知道视频信息，所以把moov放到末尾。对于moov放到视频最后的情况下，就要多一次seek，当从头开始解析的时候如果发现未找到moov信息，需要将其seek到尾部再去寻找，这样会导致起播慢。 

针对这种情况可以采用后台做转码修复，客户端增加监控打点。

解析完MOOV后需要下载多少数据才可以起播呢？ 

- Android 6.0及以下 : 5秒视频数据
- Android 7.0及以上 : 一个GOP
- FFmpeg Based Player : 关键帧

播放端识别首个关键帧即启动播放，或者通过减小GOP间隔来提高加载速度；也是可以达到的。

#### Http DNS

有关DNS相关可参考[DNS及HTTPDNS](https://github.com/CharonChui/AndroidNote/blob/master/VideoDevelopment/DNS%E5%8F%8AHTTPDNS.md)     
IP竞速

DNS解析加快，通常，DNS解析，意味着要把一个域名为xxx.com解析成ip过程，平时请求网页，网络差，就会打开网页半天。

#### 防盗链


会有一个防盗链的请求，通过 HTTP 拿到真实的播放 URL 才可以下载数据。

但是在手机上执行 HTTP 请求非常耗时，这里走私有长连接通道做这个事情。

#### 预加载

预加载能减少首次缓冲号码，但是预加载不能和当前播放的视频抢下载带宽，需要达到一个合适的阈值再开始下载。

优先保证封面图等信息完成后再根据云控的当前缓冲的时长等信息来控制是否要启动预加载

#### PCDN

有关CDN相关可参考[CDN及PCDN](https://github.com/CharonChui/AndroidNote/blob/master/VideoDevelopment/CDN%E5%8F%8APCDN.md)

    
---

- 邮箱 ：charon.chui@gmail.com  
- Good Luck! 