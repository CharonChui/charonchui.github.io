流媒体通信协议
===
 

流媒体(Streaming Media)是指采用流式传输技术在网络上连续实时播放的媒体格式，如音频、视频或多媒体文件，采用流媒体技术使得数据包得以像流水一样发送, 如果没有流媒体技术, 那么我们就要像以前用迅雷下电影一样, 下载整个影片才能观看。   



RTP
---

`Real-time Transport Protocol`(实时传输协议):是一种网络传输协议，运行在`UDP` 协议之上，`RTP`协议详细说明了在互联网上传递音频和视频的标准数据包格式。`RTP`协议常用于流媒体系统（配合`RTSP`协议）。

RTCP
---
`Real-time Transport Control Protocol`或`RTP Control Protocol`或简写`RTCP`，实时传输控制协议，是实时传输协议（`RTP`）的一个姐妹协议。`RTCP`为`RTP`媒体流提供信道外(`out-of-band`)控制。`RTCP`本身并不传输数据，但和`RTP`一起协作将多媒体数据打包和发送。`RTCP` 定期在流多媒体会话参加者之间传输控制数据。`RTCP`的主要功能是为`RTP`所提供的服务质量（`Quality of Service`）提供反馈。

RTSP
---
`Real Time Streaming Protocol`(实时流传输协议实时流传输协议):是用来控制声音或影像的多媒体串流协议，`RTSP`提供了一个可扩展框架，使实时数据，如音频与视频的受控、点播成为可能。该协议定义了一对多应用程序如何有效地通过`IP`网络传送多媒体数据。`RTSP` 在体系结构上位于`RTP`和`RTCP`之上，它使用`TCP`或`UDP`完成数据传输。使用`RTSP`时，客户机和服务器都可以发出请求，即`RTSP`可以是双向的。
`RTSP`与`RTP`最大的区别在于：`RTSP`是一种双向实时数据传输协议，它允许客户端向服务器端发送请求，如回放、快进、倒退等操作。当然，`RTSP`可基于`RTP`来传送数据，还可以选择`TCP`、`UDP`、组播`UDP`等通道来发送数据，具有很好的扩展性。它时一种类似与`http`协议的网络应用层协议。

RTMP
---
`Real Time Messaging Protocol`(实时消息传送协议):是`Adobe Systems`公司为`Flash`播放器和服务器之间音频、视频和数据传输开发的开放协议。协议基于`TCP`，是一个协议族(默认端口1935)，包括`RTMP`基本协议及`RTMPT/RTMPS/RTMPE`等多种变种。`RTMP` 是一种设计用来进行实时数据通信的网络协议，主要用来在`Flash/AIR`平台和支持`RTMP`协议的流媒体/交互服务器之间进行音视频和数据通信。市面上绝大部分PC秀场使用的都是它，他有低延迟(2s左右)、稳定性高、技术完善、高支持度、编码兼容性高等特点。但是RTMP协议不使用标准的HTTP接口传输数据(TCP、UDP端口)，所以在一些特殊的网络环境下可能被防火墙屏蔽掉。

RTMP的整体流程为:  

视频采集器 -> 支持RTMP的视频编码器 -> 网络传输  -> 流媒体服务器 -> 网络 -> 客户端


FLV
---
`Flash Video`:是Adobe公司推出的另一种视频格式，是一种在网络上传输的流媒体数据存储容器格式。其格式相对简单轻量，不需要很大的媒体头部信息。整个FLV由Header和Body以及其他Tag组成。因此加载速度极快。它是基于HTTP/80传输，可以避免被防火墙拦截的问题，除此之外，它可以通过 HTTP 302 跳转灵活调度/负载均衡，支持使用 HTTPS 加密传输，也能够兼容支持 Android，iOS 的移动端。但是由于它的传输特性，会让流媒体资源缓存在本地客户端，在保密性方面不够好，因为网络流量较大，它也不适合做拉流协议。

HDS
---
`HTTP Dynamic Streaming`:是Adobe公司的传统流媒体解决方案RTMP+FLV的组合。


HLS
---
`HTTP Live Streaming`:是苹果公司实现的基于`HTTP`的流媒体传输协议，可实现流媒体的直播和点播，主要应用在`IOS`系统，为`IOS`设备提供音视频直播和点播方案。`HLS`点播，基本上就是常见的分段`HTTP`点播，不同在于，它的分段非常小。相对于常见的流媒体直播协议，例如`RTMP`协议、`RTSP`协议、`MMS`协议等，`HLS`直播最大的不同在于，直播客户端获取到的，并不是一个完整的数据流。`HLS`协议在服务器端将
直播数据流存储为连续的、很短时长的媒体文件（`MPEG-TS`格式），而客户端则不断的下载并播放这些小文件。因为服务器端总是会将最新的直播数据生成新的小文件，这样客户端只要不停的按顺序播放从服务器获取到的文件，就实现了直播。由此可见，基本上可以认为，`HLS`是以点播的技术方式来实现直播。由于数据通过`HTTP`协议传输，所以完全不用考虑防火墙或者代理的问题，而且分段文件的时长很短，客户端可以很快的选择和切换码率，以适应不同带宽条件下的播放。不过`HLS`的这种技术特点，决定了它的延迟一般总是会高于普通的流媒体直播协议。它也解决了RTMP协议存在的一些问题，例如RTMP协议不使用标准的HTTP接口传输数据(TCP、UDP端口)，所以在一些特殊的网络环境下可能被防火墙屏蔽掉，而HLS使用的是HTTP协议传输数据(80端口)，不会遇到被防火墙屏蔽的情况。

在开始一个流媒体会话时，客户端会下载一个包含元数据的extended M3U(m3u8) playlist文件，用于寻找可用的媒体流(将视频分为一个个视频小分片，然后用m3u8索引表进行管理，由于客户端下载到的视频都是5-10秒的完整数据，所以视频的流畅性很好，但是同样也引入了很大的延迟(一般延迟在10-30s左右))。

上面提到了m3u8，那m3u8构成是？直播中m3u8、ts如何实时更新？      

- 是一个索引地址/播放列表，通过FFmpeg将本地的xxx.mp4进行切片处理，生成m3u8播放列表（索引文件）和N多个 .ts文件，并将其（m3u8、N个ts）放置在本地搭建好的webServer服务器的指定目录下，我就可以得到一个可以实时播放的网址，我们把这个m3u8地址复制到 VLC 上就可以实时观看！
在 HLS 流下，本地视频被分割成一个一个的小切片，一般10秒一个，这些个小切片被 m3u8管理，并且随着终端的FFmpeg 向本地拉流的命令而实时更新，影片进度随着拉流的进度而更新，播放过的片段不在本地保存，自动删除，直到该文件播放完毕或停止，ts 切片会相应的被删除，流停止，影片不会立即停止，影片播放会滞后于拉流一段时间

HLS的整体流程为:   

视频源文件 -> 服务器(编码器、流分割器) -> 分发器(索引文件、*.ts) -> 传输网络 -> 客户端

HDS
---
`Http Dynamic Streaming`:是一个由Adobe公司模仿HLS协议提出的另一个基于Http的流媒体传输协议。其模式与HLS类似，也是索引文件和媒体切片文件结合的下载方式，但是又要比HLS协议更复杂。

DASH
---

DASH(MPEG-DASH)全称为Dynamic Adaptive Streaming over HTTP。是国标标准组MPEG 2014年推出的技术标准，主要目标是形成IP网络承载单一格式的流媒体并提供高效与高质量服务的统一方案，解决多制式传输方案(HTTP Live Streaming, Microsoft Smooth Streaming, HTTP Dynamic Streaming)并存格局下的存储与服务能力浪费、运营高成本与复杂度、系统间互操作弱等问题。       

DASH是基于HTTP的动态自适应的比特率流技术，使用的传输协议是TCP(有些老的客户端直播会采用UDP协议直播, 例如YY, 齐齐视频等). 和HLS, HDS技术类似， 都是把视频分割成一小段一小段， 通过HTTP协议进行传输，客户端得到之后进行播放；不同的是MPEG-DASH支持MPEG-2 TS、MP4等多种格式, 可以将视频按照多种编码切割, 下载下来的媒体格式既可以是ts文件也可以是mp4文件, 所以当客户端加载视频时, 按照当前的网速和支持的编码加载相应的视频片段进行播放.          

因为是分片的，客户端可以自由选择需要播放的媒体分片，可以实现`Adaptive Bitrate Streaming`技术，不同画质内容无缝切换，提供更好的播放体验。        

YouTube采用DASH！其网页端及移动端APP都使用了DASH。

DASH的整个流程:        

内容生成服务器(编码模块、封装模块) -> 流媒体服务器(MPD、媒体文件、HTTP服务器) <-> DASH客户端(控制引擎、媒体引擎、HTTP接入容器)


Smooth Streaming
---
微软提供的一套解决方案，是IIS的媒体服务扩张，用于支持基于HTTP的自适应串流，它的文件切片为mp4，索引文件为ism/ismc。



***视频编码标准和音频编码标准是`H.264`和`AAC`，这两种标准分别是当今实际应用中编码效率最高的视频标准和音频标准。***



---

- 邮箱 ：charon.chui@gmail.com  
- Good Luck! 